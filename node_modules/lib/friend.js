var user = require('config/models');  

exports.add_friend = function(m_id, f_id, callback) {
    user.find({token: m_id}, function(err, users) {
        if (users.length != 0) {
            var me = users[0];
            
            user.find({token: f_id}, function(err, fusers) {
                if (fusers.length != 0) {
                    var person = fusers[0];
                    
                    var person_str = JSON.stringify({
                        'username': person.username,
                        'id': f_id
                    });
                    if (me.friends.indexOf(person_str) == -1) {
                        me.friends.push(person_str);
                        me.save();
                        
                        var me_str = JSON.stringify({
                            'username': me.username,
                            'id': m_id
                        });
                        if (person.friends.indexOf(me_str) == -1) {
                            person.friends.push(me_str);
                            person.save();
                        }
                        callback({'response': "Add Friend Success", 'res': true});
                    } else {
                        callback({'response': "Already had friend " + f_id, 'res': true});
                    }
                    
                } else {
                    callback({'response': "Cannot find friend user", 'res': false});
                }
            });
            
        } else {
            callback({'response': "Cannot find user while add friend", 'res': false});
        }
    });
}

exports.get_friends = function(id, callback) {
    user.find({token:id}, function(err, users) {
        if (users.length != 0) {
            var friends = users[0].friends;
            callback({'response': "Get Friends List", 'res': true, 'friends': friends});
        } else {
            callback({'response': "Cannot find user while get friends", 'res': false});
        }
    });
}