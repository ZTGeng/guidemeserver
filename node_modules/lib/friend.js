var user = require('config/models');  

exports.addFriend = function(m_id, f_id, callback) {
    user.find({token: m_id}, function(err, users) {
        if (users.length == 0) {
            callback({'response': "Error while adding favorite.", 'res': false});
        } else {
            var me = users[0];
            
            user.find({token: f_id}, function(err, fusers) {
                if (fusers.length == 0) {
                    callback({'response': "Error while adding favorite.", 'res': false});
                } else {
                    var person = fusers[0];
                    
                    var person_str = JSON.stringify({
                        'username': person.username,
                        'token': person.token
                    });
                    if (me.friends.indexOf(person_str) != -1) {
                        callback({'response': "Already a favorite.", 'res': true});
                    } else {
                        me.friends.push(person_str);
                        me.save();
                        
                        var me_str = JSON.stringify({
                            'username': me.username,
                            'token': me.token
                        });
                        if (person.friends.indexOf(me_str) == -1) {
                            person.friends.push(me_str);
                            person.save();
                        }
                        callback({'response': "Add favorite successfully.", 'res': true});
                    }
                }
            });
        }
    });
}

exports.getFriends = function(token, callback) {
    user.find({token: token}, function(err, users) {
        if (users.length == 0) {
            callback({'response': "Error while getting friends.", 'res': false});
        } else {
            var friends = users[0].friends;
            callback({'response': "Get Friends List", 'res': true, 'friends': friends});
        }
    });
}

exports.addFriendByCode = function(token, inviteCode, callback) {
    user.find({token: token}, function(err, users) {
        if (users.length == 0) {
            callback({'response': "Error while adding friend by code.", 'res': false});
        } else {
            var me = users[0];
            
            user.find({invite_code: inviteCode}, function(err, fusers) {
                if (fusers.length == 0) {
                    callback({'response': "Cannot find this code.", 'res': false});
                } else {
                    var person = fusers[0];
                    
                    var person_str = JSON.stringify({
                        'username': person.username,
                        'token': person.token
                    });
                    if (me.friends.indexOf(person_str) != -1) {
                        callback({'response': "Already a favorite.", 'res': true});
                    } else {
                        me.friends.push(person_str);
                        me.save();
                        
                        var me_str = JSON.stringify({
                            'username': me.username,
                            'token': me.token
                        });
                        if (person.friends.indexOf(me_str) == -1) {
                            person.friends.push(me_str);
                            person.save();
                        }
                        callback({'response': "Add favorite successfully.", 'res': true});
                    }
                }
            });
        }
    });
}
