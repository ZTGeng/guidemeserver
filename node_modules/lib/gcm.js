var user = require('config/models');
var room = require('lib/room');
var request = require('request');

exports.update_token = function (token, gcm_token, callback) {
    // console.log("the id is " + id + " gcm_token is " + gcm_token);
    user.find({ token: token }, function (err, users) {
        if (users.length != 0) {
            var mUser = users[0];
            mUser.gcm_token = gcm_token;
            mUser.save();

            callback({ 'response': "Update gcm token success.", 'res': true });
        } else {
            callback({ 'response': "Error while updating gcm token.", 'res': false });
        }
    });
}

// exports.call_friends = function (id, roomId, isNavigation, callback) {
//     user.find({ token: id }, function (err, users) {
//         if (users.length != 0) {
//             var mUser = users[0];
            
//             user.find({ username: { $in: mUser.friends } }, function(err, friends) {
//                 if (friends.length != 0) {
//                     callback({ 'response': "Sending notifications to friends", 'res': true });
//                     // console.log(friends);
//                     for (var i = 0; i < friends.length; i++) {
//                         if (friends[i].gcm_token) {
//                             call_friend(mUser.username, friends[i].gcm_token, roomId, isNavigation);
//                         } else {
//                             console.log("Cannot call " + friends[i].username);
//                         }
//                     }
//                 } else {
//                     callback({ 'response': "User has no friends", 'res': false });
//                 }
//             });
//         } else {
//             callback({ 'response': "Cannot find the user", 'res': false });
//         }
//     });
// }

exports.callFriendsById = function (token, friends, des, callback) {
    user.find({token: token}, function(err, users) {
        if (users.length == 0) {
            callback({'response': "Error while calling friends.", 'res': false});
        } else {
            var mUser = users[0];
            var called = false;
            for (var i = 0; i < friends.length; i++) {
                user.find({token: friends[i]}, function(err, fusers) {
                    if (fusers.length == 0) {
                        console.log("Cannot find and ignore " + friends[i]);
                    } else {
                        var callee = fusers[0];
                        var query = JSON.stringify({
                            'username': callee.username,
                            'id': callee.token
                        });
                        if (mUser.friends.indexOf(query) == -1) {
                            console.log(callee.username + " is not a friend!");
                        } else {
                            if (callee.gcm_token) {
                                console.log("Call " + callee.username);
                                var rateFloat = Math.round((mUser.rateTotal / mUser.rateNum) * 10) / 10;
                                call_friend(mUser.username, callee.gcm_token, token, des, rateFloat);
                                called = true;
                            } else {
                                console.log("Cannot call " + callee.username);
                            }
                        }
                    }
                });
            }
            if (called) {
                room.createRoom(token, des, "private", function(found) {
                    console.log(found);
                });
                callback({ 'response': "Sent notifications to selected friends", 'res': true });
            } else {
                callback({ 'response': "Did not send notifications to any friend", 'res': false });
            }
        }
    });
}

var call_friend = function (username, friend_token, room_id, des, rate) {
    request({
        url: 'https://gcm-http.googleapis.com/gcm/send',
        headers: {
            'Content-Type': 'application/json',
            Authorization: 'key=AIzaSyBfR312em44wB7NPmVXwAJouVjj9Rz7jes'
        },
        method: 'POST',
        json: true,
        body: {
            "data": {
                sender: username,
                room_id: room_id,
                des: des,
                rate: rate,
                time: (new Date()).getTime
            },
            "to": friend_token
        }
    }, function () { });
};